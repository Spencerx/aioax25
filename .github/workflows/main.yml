name: Pre-merge and post-merge tests

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      skip-coverage:
        # lcov won't work in Python 3.5.
        description: "Whether to skip coverage checks?"
        type: boolean
        required: false
        default: false

permissions:
  contents: read

jobs:
  test:
    name: Run tests
    uses: ./.github/workflows/test.yml
    # https://wildwolf.name/github-actions-how-to-avoid-running-the-same-workflow-multiple-times/
    if: >
      github.event_name != 'pull_request'
      || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
    strategy:
      matrix:
        # See https://raw.githubusercontent.com/actions/python-versions/refs/heads/main/versions-manifest.json for versions
        python:
        - "3.9"   # Oldest tested; consistent with Debian 11
        - "3.10"  # consistent with Ubuntu 22.04
        - "3.11"  # consistent with Debian 12
        - "3.12"  # consistent with Ubuntu 24.04
        - "3.13"  # consistent with Debian 13
        #- "3.14"  # Current latest release of Python -- TODO
        platform:
        # This package is supposed to be OS-independent and is unlikely to have
        # OS-specific bugs, so we conserve runner usage by only testing on Linux
        # during pre-merge and post-merge testing. If it works on Linux, it'll
        # probably work on Mac and Windows too. But if an OS-specific bug does
        # slip through, we should catch it in pre-release testing.
        - ubuntu-latest
    with:
      python-version: ${{ matrix.python }}
      platform: ${{ matrix.platform }}
      skip-coverage: ${{ matrix.skip-coverage || false }}

  check:  # This job does nothing and is only used for the branch protection
    # https://wildwolf.name/github-actions-how-to-avoid-running-the-same-workflow-multiple-times/
    if: >
      github.event_name != 'pull_request'
      || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name

    needs:
    - test

    runs-on: ubuntu-latest

    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@release/v1
      with:
        jobs: ${{ toJSON(needs) }}
